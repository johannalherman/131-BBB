<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chem 131 BBB-1 Simulation</title>
    <style>
      body {
        max-width: 1000px;
        margin: auto;
        font:
          18px Arial,
          sans-serif;
        text-align: center;
        padding: 20px;
      }

      #instruction-message {
        margin: auto;
        text-align: left;
      }

      hr {
        border: 5px solid #ff2e37;
        border-radius: 5px;
      }


      #dropdown-container {
        margin: 40px auto 40px auto;
        font-size: 18px;
        font-weight: bold;
        width: 800px;
        gap: 10px;
        padding: 10px 30px;
        background-color: #ffd7e1;
        border: 2px solid black;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      #acidSetSelector {      
        font-size: 18px;
      }

      #resetButton {
        font-size: 18px;
        background-image: linear-gradient(#ff9ab3, #fedee6 50%, #ff9ab3);
        padding: 10px 20px;
        margin-left: 80px;
        border: 2px solid #FF2E37;
        border-radius: 5px;
        user-select: none;
      }
      #resetButton:hover {
        border: 2px solid white;
      }

      .reset-button-container button {
        padding: 10px 20px;
        font-size: 16px;
        background-image: linear-gradient(#ff9ab3, #fedee6 50%, #ff9ab3);
        border: 2px solid #FF2E37;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .reset-button-container button:hover {
        border: 2px solid white;
      }
      .reset-button-container button:focus {
        padding: 9px 19px;
        border: 3px solid #FF2E37;
      }

      .button-container {
        text-align: center;
      }
      .button-container button {
        font-size: 16px;
        margin: 20px 5px 0px 5px;
        padding: 10px 20px;
        border: 2px solid;
        border-radius: 5px;
        cursor: pointer;
      }  
      .button-container button:hover {
        border: 2px solid white;
      }
      .button-container button:focus {
        padding: 9px 19px;
        border: 3px solid #FF2E37;
      }

      .control-button {
        padding: 10px 20px;
        font-size: 16px;
        background-image: linear-gradient(#ff9ab3, #fedee6 50%, #ff9ab3);
        border: 2px solid #FF2E37;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .control-button:hover {
        border: 2px solid white;
      }
      .control-button:focus {
        padding: 9px 19px;
        border: 3px solid #FF2E37;
      }

      .row {
        display: flex;
      }
      .column {
        flex: 50%;
        padding: 0px 20px;
      }
      

      #glassware-container-1 { 
        text-align: center; 
        position: relative; 
      }
      #flask-1 {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        z-index: 10;
      }
      #balance-1 {
        position: absolute;
        bottom: -35.5%;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        z-index: 10;
      }
      canvas { 
        display: block; 
        margin: auto; 
        position: relative;
        bottom: -7px;
        width: 215px;
        height: 320px;
        z-index: -10; 
      }
      #total-mass-1 {
        position: absolute;
        bottom: -108px; 
        left: 50%;
        transform: translateX(-50%);
        border-radius: 5px;
        font-size: 24px;
        font-weight: bold;
        z-index: 10;
      }      

      #glassware-container-2, #glassware-container-3 { 
        display: block;
        margin: auto; 
        position: relative;
      }

      #total-mass-2 {
        position: absolute;
        bottom: 2.5%; /* Adjust as needed */
        left: 50%; /* Adjust as needed */
        transform: translateX(-50%);
        border-radius: 5px;
        font-size: 24px;
        font-weight: bold;
        z-index: 0;
      }
      #total-mass-3 {
        position: absolute;
        bottom: 118px; /* Adjust as needed */
        left: 50%; /* Adjust as needed */
        transform: translateX(-50%);
        border-radius: 5px;
        font-size: 24px;
        font-weight: bold;
        z-index: 0;
      }

      #cylinder,
      #flask-3 {
        display: absolute;
        width: 400px;
        z-index: 0;
      }

      #balance-3 {
        position: relative;
        bottom: 107px;
        width: 400px;
        z-index: 0;
      }

      #solution {
        position: absolute;
        bottom: 23.9%;
        left: 50%;
        transform: translateX(-50%);
        width: 13%;
        height: 0;
        background: #abdcf2;
        transition: height 0.3s ease-in-out;
        opacity: 0.75;
        z-index: -10;
      }
      .solution::after {
        content: "";
        position: absolute;
        top: 0px;
        right: 50%;
        transform: translateX(50%);
        width: 100%;
        height: 5px;
        background: #def1fa; /* Subtle meniscus highlight */
        border-radius: 0% 0% 50% 50%; /* Round only the bottom corners */
        z-index: 0;
      }

      #mixture {
        position: absolute;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
        height: 0;
        background: #abdcf2;
        transition: height 0.3s;
        opacity: 0.75;
        border-radius: 5px;
        z-index: -10;
      }

      .tilt {
        animation: tiltAnimation 0.5s 4.5 alternate ease-in-out;
      }
      @keyframes tiltAnimation {
        0% {transform: rotate(-5deg) translateY(-20px);}
        50% {transform: rotate(5deg) translateY(-20px);}
        100% {transform: rotate(-5deg) translateY(-20px);}
      }

      .slosh {
        animation: sloshAnimation 0.5s 4.5 alternate ease-in-out;
      }        
        @keyframes sloshAnimation {
            0% { transform: rotate(-3deg) translateY(-15px) translateX(-50%);}
            100% { transform: rotate(3deg) translateY(-15px) translateX(-50%);}
        }
      
    </style>
  </head>
  <body>  
    <div id="dropdown-container">
      <label for="acidSetSelector">Select Assigned Food Acid:</label>
      <select id="acidSetSelector">
        <option value="" selected>Choose from Dropdown</option>
        <option value="set1">Citric Acid</option>
        <option value="set2">Malic Acid</option>
        <option value="set3">Malonic Acid</option>
        <option value="set4">Tartaric Acid</option>
      </select>
      <button id="resetButton" class="control-button">Reset All Controls</button>
    </div>

    <div class="row" style="margin-bottom: 100px">
      <div class="column">
        <!--Balance Area #1 Code-->
        <div id="glassware-container-1" style="margin-top: 88px">
          <img id="flask-1" src="https://github.com/johannalherman/131-BBB/blob/main/Falsk2.png?raw=true" alt="Background">
          <canvas id="canvas"></canvas>
          <img id="balance-1" src="https://github.com/johannalherman/131-BBB/blob/main/Balance.png?raw=true">
          <p id="total-mass-1"><span>0.000</span> g</p>
        </div>

        <div class="button-container" style="margin-top: 120px;">
          <button id="addSmallParticlesBtn">Add Small Amount</button>
          <button id="addLargeParticlesBtn">Add Large Amount</button>
        </div>
        <div class="button-container">
          <button id="tareButton-1" class="control-button">Tare Balance</button>
          <button id="clearButton" class="control-button">Empty Flask</button>
        </div>
      </div>

      <div class="column">
        <!--Balance Area #2 Code-->
        <div id="glassware-container-2">
          <div id="solution" class="solution"></div>
          <img id="cylinder" src="https://github.com/johannalherman/Chem131/blob/main/Graduated%20Cylinder%20on%20Balance.png?raw=true" />
          <p id="total-mass-2"><span>0.000</span> g</p>
        </div>

        <div class="button-container">
          <button id="dropsButton">Add Drops</button>
          <button id="pourButton">Pour In</button>
        </div>        
        <div class="button-container">
          <button id="tareButton-2" class="control-button">Tare Balance</button>
          <button id="removeSolution" class="control-button">Pour Out</button>
        </div>
      </div>
    </div>

    <!--Balance Area #1 Code-->
    <div id="glassware-container-3" style="width: 600px">
      <div id="mixture"></div>
      <img id="flask-3" src="https://github.com/johannalherman/131-BBB/blob/main/Falsk2.png?raw=true" />
      <img id="balance-3" src="https://github.com/johannalherman/131-BBB/blob/main/Balance.png?raw=true" />
      <p id="total-mass-3"><span>0.000</span> g</p>
    </div>

    <div class="button-container" style="margin-bottom: 40px">
      <button onclick="mix()">Start Reaction!</button>
      <button onclick="stirFlask()">Stir Flask</button>
    </div>

    <script>
      let amount = 0
      
    	let acidMass = 0
      let flask1Mass = getRandomAmount(35, 40)
      let totalMass_1 = flask1Mass
      let tareOffset1 = 0
      
      let cylinderMass = getRandomAmount(25, 30)
      let totalMass2 = cylinderMass
      let tareOffset2 = 0
      let solVolume = 0
      let liquidHeight2 = 0
      let cylinderVolume = 380 // Total px hieght volume of the cylinder
      let px_scalor_2 = 36.35 // number of px in mL in cylinder image
      let increment = 0 // Adjust this value for how much water should be added to cylinder per click
      
      let mixVolume = 0
      let totalMass3 = 0
      
			updateMassDisplay_1() // run at start
      updateMassDisplay2()
      
      document.getElementById("resetButton").addEventListener("click", () => {
      	amount = 0
        
        acidMass = 0
        tareOffset1 = 0
        totalMass_1 = flask1Mass
        pileHeight = 0
        pileWidth = 0
        updateMassDisplay_1()
      
        solVolume = 0
        totalMass2 = cylinderMass
        tareOffset2 = 0
        liquidHeight2 = 0
        updateMassDisplay2()
        
        mixVolume = 0
        totalMass3 = 0
        
        updateMassDisplay3()
        
        document.getElementById("solution").style.height = 0 + "px"
        document.getElementById("mixture").style.height = 0 + "px"
      });


      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const addSmallParticlesBtn = document.getElementById("addSmallParticlesBtn");
      const addLargeParticlesBtn = document.getElementById("addLargeParticlesBtn");

      const particles = [];
      const gravity = 0.25;
      const particleRadius = 4;
      let pileHeight = 0;
      let pileWidth = 0;
      
      function getRandomAmount(min, max) {
      	return Math.random() * (max - min) + min;
    	}


      function Particle(x, y, delay) {
        this.x = x;
        this.y = y;
        this.vy = 0;
        this.stable = false;
        this.delay = delay;
      }

      Particle.prototype.update = function () {
        if (!this.stable) {
          if (this.delay > 0) {
            this.delay--;
            return;
          }
          this.vy += gravity;
          this.y += this.vy;

          if (this.y + particleRadius >= canvas.height - pileHeight) {
            this.stable = true;
            particles.splice(particles.indexOf(this), 1);
            pileHeight += 0.5;
            pileWidth += 10;
          }
        }
      };

      function addParticles(size) {
      	if (size === 'small') {
        	amount = 5;
        } else {
        	amount = 15;
        }
        for (let i = 0; i < amount; i++) {
          const x = canvas.width / 2 + Math.random() * 10 - 5;
          const y = 0;
          const delay = Math.floor(Math.random() * 10); // Random delay for staggered falling
          const newParticle = new Particle(x, y, delay);
          particles.push(newParticle);
        }
        
        if (size === 'small') {
        	addMass = getRandomAmount(0.005, 0.020);
        } else {
        	addMass = getRandomAmount(0.100, 0.200);
        }
        totalMass_1 += addMass;
        acidMass += addMass;
        setTimeout(() => { updateMassDisplay_1()}, 500); }
      
      function updateMassDisplay_1() {
      	document.getElementById("total-mass-1").textContent = `${(totalMass_1 - tareOffset1).toFixed(3)} g`;
      }    
      
      document.getElementById("tareButton-1").addEventListener("click", () => {
        tareOffset1 = totalMass_1;
        updateMassDisplay_1();
      });   
      
      document.getElementById("clearButton").addEventListener("click", () => {
        tareOffset1 = 0;
        totalMass_1 = flask1Mass;
        pileHeight = 0;
        pileWidth = 0;
        updateMassDisplay_1();
      });

      function update() {
        particles.forEach(p => p.update());
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#eddcc8";
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, particleRadius, 0, Math.PI * 2);
          ctx.fill();
        });

        // Draw growing triangular pile with shadow and border
        ctx.save(); // Save current context state
        ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;

        ctx.fillStyle = "#eddcc8";
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2 - pileWidth, canvas.height);
        ctx.lineTo(canvas.width / 2 + pileWidth, canvas.height);
        ctx.lineTo(canvas.width / 2, canvas.height - pileHeight);
        ctx.closePath();
        ctx.fill();

        ctx.restore(); // Restore previous context state
      }

      function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
      }

      addSmallParticlesBtn.addEventListener("click", () => addParticles("small"));
      addLargeParticlesBtn.addEventListener("click", () => addParticles("large"));
      loop();
      
      
      
   

      document.getElementById("dropsButton").addEventListener("click", () => {
        addSolution("drops");
      }); 
      document.getElementById("pourButton").addEventListener("click", () => {
        addSolution("pour");
      });  
      document.getElementById("removeSolution").addEventListener("click", () => {
        removeSolution();
      }); 
      


      const mixButton = document.querySelector('button[onclick="mix()"]')
      const stirFlaskButton = document.querySelector('button[onclick="stirFlask()"]')

             
      document.getElementById("tareButton-2").addEventListener("click", () => {
        tareOffset2 = totalMass2
        updateMassDisplay2()
      });  
      
      function addSolution(size) {
        if (size === 'drops') {
        	amount = getRandomAmount(0.1, 0.3)
        } else {
        	amount = getRandomAmount(3, 4.5)
        }
        solVolume = Math.min(cylinderVolume / px_scalor_2, solVolume + amount)
        totalMass2 = solVolume + cylinderMass //should add formula for soln density!!
        updateMassDisplay2()
        increaseLiquidLevel2()
      }

      function removeSolution() {
        amount = getRandomAmount(2, 3)
        if (amount >= solVolume) {
          amount = solVolume
        }
        solVolume = Math.max(0, solVolume - amount)
        totalMass2 = solVolume + cylinderMass
        updateMassDisplay2()
        increaseLiquidLevel2()
      }

      function increaseLiquidLevel2() {
        if (solVolume > 0) {
          document.getElementById("solution").style.height =
            solVolume * px_scalor_2 + 4 + "px"
        } else {
          document.getElementById("solution").style.height =
            solVolume * px_scalor_2 + "px"
        }
      }
      function updateMassDisplay2() {
        document.querySelector("#total-mass-2 span").textContent =
          (totalMass2 - tareOffset2).toFixed(3)
      }

      function mix() {
        mixVolume = (solVolume*10) + acidMass + 15
        totalMass3 = acidMass + solVolume //needs formula and exponential decay formula!!
        updateMassDisplay3()
        increaseLiquidLevel3()
      }

      function stirFlask() {
        const img1 = document.getElementById("flask-3")
        img1.classList.remove("tilt")
        void img1.offsetWidth // Trigger reflow to restart animation
        img1.classList.add("tilt")
        
        const img2 = document.getElementById("mixture")
        img2.classList.remove("slosh")
        img2.classList.add("slosh")
      }

      function increaseLiquidLevel3() {
        document.getElementById("mixture").style.height = mixVolume + "px"
      }
      function updateMassDisplay3(solVoume) {
        document.querySelector("#total-mass-3 span").textContent =
          totalMass3.toFixed(3)
      }
    </script>
  </body>
</html>
